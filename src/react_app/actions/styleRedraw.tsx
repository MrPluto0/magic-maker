import StyleRedraw from "@/components/draw/tools/StyleRedraw.vue";
import { useDrawStore } from "@/stores/drawState";
import { ExcalidrawImageElement } from "@pkg/excalidraw/types/element/types";
import { ExcalidrawImperativeAPI } from "@pkg/excalidraw/types/types";
import { createApp } from "vue";

export const actionStyleRedraw = async (api: ExcalidrawImperativeAPI) => {
  api.registerAction({
    name: "Style Redraw",
    label: "风格重绘",
    icon: (
      <svg
        viewBox="0 0 1024 1024"
        version="1.1"
        xmlns="http://www.w3.org/2000/svg"
        p-id="6670"
        width="16"
        height="16"
      >
        <path
          d="M887.478857 157.878857V102.4q0-14.153143-10.020571-24.137143-9.984-9.984-24.137143-9.984H102.4q-14.153143 0-24.137143 9.984t-9.984 24.137143v750.957714q0 14.116571 9.984 24.137143 9.984 9.984 24.137143 9.984h55.478857v68.278857H102.4q-42.422857 0-72.411429-29.988571-29.988571-29.988571-29.988571-72.411429V102.4Q0 59.977143 29.988571 29.988571 59.977143 0 102.4 0h750.957714q42.422857 0 72.411429 29.988571 29.988571 29.988571 29.988571 72.411429v55.478857h-68.278857zM204.8 273.078857v682.678857q0 28.269714 20.004571 48.274286 20.004571 19.968 48.274286 19.968h682.678857q28.269714 0 48.274286-20.004571 19.968-19.968 19.968-48.274286V273.115429q0-28.269714-20.004571-48.274286-19.968-20.004571-48.274286-20.004572H273.115429q-28.269714 0-48.274286 20.004572T204.8 273.078857z m68.278857 634.404572V765.074286L340.114286 698.002286a23.332571 23.332571 0 0 1-19.638857-24.978286l4.754285-56.685714-52.187428 52.187428v-142.372571l253.074285-253.074286h142.372572l-53.394286 53.394286 5.266286 0.036571c17.042286 0.402286 34.340571-0.073143 50.944-3.84a148.48 148.48 0 0 1 47.177143-3.072l46.555428-46.518857h142.409143l-93.842286 93.805714c15.872 17.188571 27.830857 38.326857 34.230858 62.317715l107.885714-107.885715v142.409143l-57.490286 57.490286c5.485714 7.021714 8.484571 15.908571 8.045714 25.234286l-3.401142 66.669714 52.845714-52.845714v142.409143l-253.074286 253.074285H560.274286l56.32-56.356571h-3.181715c-16.932571-0.146286-34.048 0.548571-50.541714 4.315428a157.622857 157.622857 0 0 1-50.322286 3.218286l-48.822857 48.822857H321.353143l94.610286-94.646857a156.781714 156.781714 0 0 1-37.12-59.428571l-105.764572 105.801143z m156.525714-634.404572l-156.525714 156.525714v-156.525714h156.525714z m-23.771428 323.072a206.848 206.848 0 0 1 160.768-185.526857 207.286857 207.286857 0 0 1 142.701714 19.090286l-7.606857-33.28 55.332571-12.617143 7.314286 32.365714 5.888 25.746286 12.068572 52.882286 0.036571 0.365714a28.416 28.416 0 0 1-21.284571 33.938286l-16.969143 3.876571-5.046857 1.170286-1.170286 0.256-45.787429 10.496-20.114285 4.608a14.665143 14.665143 0 0 1-0.365715 0.073143l-10.386285 2.377142-2.450286-10.752-3.657143-15.798857-6.546286-28.708571 45.056-10.313143a150.381714 150.381714 0 0 0-123.830857-18.029714 150.308571 150.308571 0 0 0-101.814857 101.814857 152.283429 152.283429 0 0 0-5.668571 30.537143l-2.304 28.306285-56.502858-4.681142 2.377143-28.196572z m37.12 136.96a28.342857 28.342857 0 0 1 21.284571-33.901714l99.84-22.857143 3.364572 14.738286v0.109714l3.474285 14.994286 5.814858 25.417143-40.484572 9.252571a149.211429 149.211429 0 0 0 113.517714 19.236571 151.588571 151.588571 0 0 0 117.211429-139.593142l1.462857-28.342858 56.649143 2.889143-0.841143 16.164572v0.292571l-0.621714 11.885714a206.08 206.08 0 0 1-33.170286 102.180572 209.737143 209.737143 0 0 1-61.805714 61.769143 206.262857 206.262857 0 0 1-66.194286 28.013714 210.102857 210.102857 0 0 1-60.891428 4.900571l-2.194286-0.146285a204.470857 204.470857 0 0 1-84.516572-26.368l8.740572 38.217143-55.332572 12.580571-6.582857-29.110857-7.606857-33.353143-10.313143-45.312-0.804571-3.657143z m356.278857 222.646857l156.525714-156.525714v156.525714h-156.525714z"
          p-id="6671"
          fill="currentColor"
        ></path>
      </svg>
    ),
    perform: async (elements, appState) => {
      const store = useDrawStore();
      const ele = store.getSelected() as ExcalidrawImageElement;
      const files = store.api.getFiles();
      if (!files[ele.fileId]) {
        return {
          elements,
          appState,
          storeAction: "none",
        };
      }
      // 动态创建Vue组件
      const container = document.createElement("div");
      document.body.appendChild(container);
      const comp = createApp(StyleRedraw, {
        dataUrl: files[ele.fileId].dataURL,
        onFinish: (url: string) => {
          store.replaceFile(url, ele);
        },
      });
      comp.mount(container);
      // 默认输出
      return {
        elements,
        appState,
        storeAction: "none",
      };
    },
    custom: true,
    visible: (elements, appState) => {
      const id = Object.keys(appState.selectedElementIds)[0];
      return (
        elements.findIndex((ele) => ele.id === id && ele.type === "image") !==
        -1
      );
    },
  });
};
