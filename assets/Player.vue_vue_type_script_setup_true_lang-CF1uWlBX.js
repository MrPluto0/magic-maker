var m=i=>{throw TypeError(i)};var z=(i,t,e)=>t.has(i)||m("Cannot "+e);var S=(i,t,e)=>t.has(i)?m("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(i):t.set(i,e);var l=(i,t,e)=>(z(i,t,"access private method"),e);import{N as A,D as k,a as D,O as C,ac as $,ad as B,J as L,d as M,ae as N,r as g,G as V,o as E,g as x,h as y,q as H,V as O,u as n,s as v,i as W,f as _,e as w}from"./index-C9HzHbyJ.js";import{_ as j}from"./PlayerMoveable.vue_vue_type_style_index_0_lang-D9R-RBpv.js";import{_ as q}from"./PlayerControl.vue_vue_type_script_setup_true_lang-IJcLVU8F.js";var s,b,T,F,P,u;class G{constructor(t){S(this,s);this.playerStore=A(),this.trackState=k(),this.canvasSize=D({width:0,height:0}),this.playerTimer=0,this.playerContext=null,this.audioPlayAt=0,this.audioContext=new AudioContext,this.captureAudioDest=this.audioContext.createMediaStreamDestination(),this.playingAudioCache=new Set,this.player=t.player,this.playerContext=this.player.value.getContext("bitmaprenderer"),C([()=>this.trackState.trackList,()=>this.canvasSize,()=>this.playerStore.playStartFrame],()=>l(this,s,b).call(this),{deep:!0}),C(()=>this.playerStore.isPause,()=>{this.playerStore.isPause?l(this,s,u).call(this):l(this,s,P).call(this)})}}s=new WeakSet,b=async function(){if(this.playerStore.ingLoadingCount!==0)return;const t=[],e=[];this.playerStore.playingTracks.forEach(async r=>{r instanceof B?e.push(r):t.unshift(r)}),t.push(...e),l(this,s,T).call(this,t),this.playerStore.isPause||l(this,s,F).call(this,e)},T=async function(t){const e=new OffscreenCanvas(this.playerStore.playerWidth,this.playerStore.playerHeight),r=e.getContext("2d");for(const o of t)await o.draw(r,this.playerStore.playerWidth,this.playerStore.playerHeight,this.playerStore.playStartFrame);this.playerContext&&this.playerContext.transferFromImageBitmap(e.transferToImageBitmap())},F=async function(t){var h;const e=[];for(const a of t){const p=await a.render(this.audioContext,this.playerStore.playStartFrame);p&&e.push(p)}const r=Math.max(this.audioContext.currentTime,this.audioPlayAt);let o=0;for(const a of e)a.start(r),a.connect(this.audioContext.destination),a.connect(this.captureAudioDest),this.playingAudioCache.add(a),a.onended=()=>{a.disconnect(),this.playingAudioCache.delete(a)},o=Math.max(o,((h=a.buffer)==null?void 0:h.duration)??0);this.audioPlayAt=r+o},P=function(){this.playerStore.playStartFrame>=this.trackState.frameCount&&(this.playerStore.playStartFrame=0),this.audioContext.resume(),this.audioPlayAt=0,this.playerTimer=$(()=>{this.playerStore.playStartFrame++,this.playerStore.playStartFrame>=this.trackState.frameCount&&l(this,s,u).call(this)},1e3/L)},u=function(){var t;(t=this.playerTimer)==null||t.cancel(),this.audioContext.suspend();for(const e of this.playingAudioCache)e.stop(),e.disconnect();this.playingAudioCache.clear()};const I={class:"h-full flex flex-col dark:bg-night bg-gray-100"},J={class:"flex-1 relative overflow-hidden"},R={key:0,class:"absolute left-0 right-0 top-0 bottom-0 z-20 flex justify-center items-center"},Y=M({__name:"Player",props:{containerSize:{type:Object,default(){return{width:0,height:0}}}},setup(i){const t=i,e=A(),{playerWidth:r,playerHeight:o}=N(e),h=k(),a=g(),p=g(),f=V(()=>{let{width:d,height:c}=t.containerSize;return c-=70,d-=10,Math.min(d/r.value,c/o.value)});return E(()=>{p.value=new G({player:a})}),(d,c)=>(w(),x("div",I,[y("div",J,[H(y("canvas",{ref_key:"playerCanvas",ref:a,class:"absolute left-0 right-0 top-0 bottom-0 m-auto bg-gray-900",id:"player",style:v({zoom:n(f),width:`${n(r)}px`,height:`${n(o)}px`})},null,4),[[O,n(h).frameCount>0]]),n(h).frameCount===0?(w(),x("div",R,c[0]||(c[0]=[y("i",{class:"i-mdi-video",style:{fontSize:"144px",opacity:.5,color:"#FDE68A"}},null,-1)]))):W("",!0),_(j,{style:v({zoom:n(f),width:`${n(r)}px`,height:`${n(o)}px`})},null,8,["style"])]),_(q)]))}});export{Y as _};
