var m=i=>{throw TypeError(i)};var D=(i,t,e)=>t.has(i)||m("Cannot "+e);var S=(i,t,e)=>t.has(i)?m("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(i):t.set(i,e);var l=(i,t,e)=>(D(i,t,"access private method"),e);import{O as A,C as k,a as $,P as C,au as B,av as E,J as L,d as M,aw as H,r as x,D as I,o as N,g,k as _,n as O,Y as V,u as n,p as v,f as p,w as W,h as j,i as J,e as w,ax as R}from"./index-DnwN-RZ1.js";import{_ as Y}from"./PlayerMoveable.vue_vue_type_style_index_0_lang-DlYliXUj.js";import{_ as q}from"./PlayerControl.vue_vue_type_script_setup_true_lang-BfMN58aN.js";var s,b,P,T,F,y;class G{constructor(t){S(this,s);this.playerStore=A(),this.trackState=k(),this.canvasSize=$({width:0,height:0}),this.playerTimer=0,this.playerContext=null,this.audioPlayAt=0,this.audioContext=new AudioContext,this.captureAudioDest=this.audioContext.createMediaStreamDestination(),this.playingAudioCache=new Set,this.player=t.player,this.playerContext=this.player.value.getContext("bitmaprenderer"),C([()=>this.trackState.trackList,()=>this.canvasSize,()=>this.playerStore.playStartFrame],()=>l(this,s,b).call(this),{deep:!0}),C(()=>this.playerStore.isPause,()=>{this.playerStore.isPause?l(this,s,y).call(this):l(this,s,F).call(this)})}}s=new WeakSet,b=async function(){if(this.playerStore.ingLoadingCount!==0)return;const t=[],e=[];this.playerStore.playingTracks.forEach(async r=>{r instanceof E?e.push(r):t.unshift(r)}),t.push(...e),l(this,s,P).call(this,t),this.playerStore.isPause||l(this,s,T).call(this,e)},P=async function(t){const e=new OffscreenCanvas(this.playerStore.playerWidth,this.playerStore.playerHeight),r=e.getContext("2d");for(const o of t)await o.draw(r,this.playerStore.playerWidth,this.playerStore.playerHeight,this.playerStore.playStartFrame);this.playerContext&&this.playerContext.transferFromImageBitmap(e.transferToImageBitmap())},T=async function(t){var h;const e=[];for(const a of t){const c=await a.render(this.audioContext,this.playerStore.playStartFrame);c&&e.push(c)}const r=Math.max(this.audioContext.currentTime,this.audioPlayAt);let o=0;for(const a of e)a.start(r),a.connect(this.audioContext.destination),a.connect(this.captureAudioDest),this.playingAudioCache.add(a),a.onended=()=>{a.disconnect(),this.playingAudioCache.delete(a)},o=Math.max(o,((h=a.buffer)==null?void 0:h.duration)??0);this.audioPlayAt=r+o},F=function(){this.playerStore.playStartFrame>=this.trackState.frameCount&&(this.playerStore.playStartFrame=0),this.audioContext.resume(),this.audioPlayAt=0,this.playerTimer=B(()=>{this.playerStore.playStartFrame++,this.playerStore.playStartFrame>=this.trackState.frameCount&&l(this,s,y).call(this)},1e3/L)},y=function(){var t;(t=this.playerTimer)==null||t.cancel(),this.audioContext.suspend();for(const e of this.playingAudioCache)e.stop(),e.disconnect();this.playingAudioCache.clear()};const K={class:"h-full flex flex-col dark:bg-night bg-gray-100"},Q={class:"flex-1 relative overflow-hidden"},U={key:0,class:"absolute left-0 right-0 top-0 bottom-0 z-20 flex justify-center items-center"},at=M({__name:"Player",props:{containerSize:{type:Object,default(){return{width:0,height:0}}}},setup(i){const t=i,e=A(),{playerWidth:r,playerHeight:o}=H(e),h=k(),a=x(),c=x(),f=I(()=>{let{width:d,height:u}=t.containerSize;return u-=70,d-=10,Math.min(d/r.value,u/o.value)});return N(()=>{c.value=new G({player:a})}),(d,u)=>{const z=J;return w(),g("div",K,[_("div",Q,[O(_("canvas",{ref_key:"playerCanvas",ref:a,class:"absolute left-0 right-0 top-0 bottom-0 m-auto bg-gray-900",id:"player",style:v({zoom:n(f),width:`${n(r)}px`,height:`${n(o)}px`})},null,4),[[V,n(h).frameCount>0]]),n(h).frameCount===0?(w(),g("div",U,[p(z,{size:144,class:"box-content opacity-50",style:{color:"#FDE68A"}},{default:W(()=>[p(n(R))]),_:1})])):j("",!0),p(Y,{style:v({zoom:n(f),width:`${n(r)}px`,height:`${n(o)}px`})},null,8,["style"])]),p(q)])}}});export{at as _};
