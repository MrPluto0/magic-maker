import{d as P,D as V,N as X,G as R,r as j,q as z,V as B,g as G,h as L,n as H,J as W,e as q}from"./index-C9HzHbyJ.js";import{g as b}from"./canvasUtil-Buwp7mdT.js";const K=P({__name:"TrackHandler",props:{isActive:{type:Boolean,default:!1},lineIndex:{type:Number,default:0},itemIndex:{type:Number,default:0}},setup(k){const e=k,o=V(),S=X(),y=R(()=>o.trackList[e.lineIndex].list[e.itemIndex]),v=j();let E=0;const w={isVA:!1,start:0,end:0,offsetR:0,offsetL:0,minStart:0,maxStart:0,minEnd:0,maxEnd:0};let M=!1,I=[];function C(i,t=10){const r=[];I.forEach(n=>{Math.abs(n.left-i)<=t&&r.push({position:n.left,frame:n.start}),Math.abs(n.right-i)<=t&&r.push({position:n.right,frame:n.end})});const s=b(o.trackScale,S.playStartFrame);return Math.abs(s-i)<=t&&r.push({position:s,frame:S.playStartFrame}),r}function T(i,t){return t.length===0?void 0:t.reduce((s,n)=>Math.abs(n.position-i)<Math.abs(s.position-i)?n:s,{position:Number.MAX_SAFE_INTEGER,frame:0})}const D=R(()=>b(o.trackScale,1));function F(i,t){const r=e.itemIndex>0?i[e.itemIndex-1]:null,s=e.itemIndex<i.length?i[e.itemIndex+1]:null,n=["video","audio"].includes(t.type),f={isVA:n,start:t.start,end:t.end,offsetR:t.offsetR,offsetL:t.offsetL,minStart:r?r.end:0,maxStart:t.end-1,minEnd:t.start+1,maxEnd:s?s.start:W*60*60};if(n){const u=t.frameCount-f.offsetL,c=t.frameCount-f.offsetR;f.maxEnd=s?Math.min(s.start,f.start+u):Math.min(u+f.start,W*60*60),f.minStart=r?Math.max(r.end,f.end-c):Math.max(f.end-c,0)}Object.assign(w,{...f})}function N(i,t){const{isVA:r,start:s,end:n,offsetR:f,offsetL:u,minStart:c,maxStart:d,minEnd:m,maxEnd:l}=w,p=n-s,x=u+p,g=f+p;if(t==="left"){let a=s+i;a>d&&(a=d),a<c&&(a=c);let h=a-s;r?(n-a>x&&(a=n-x,h=a-s),o.trackList[e.lineIndex].list[e.itemIndex].offsetL=Math.max(u+h,0)):o.trackList[e.lineIndex].list[e.itemIndex].frameCount=n-a,o.trackList[e.lineIndex].list[e.itemIndex].start=a}else{let a=n+i;if(a>l&&(a=l),a<m&&(a=m),r){a-s>g&&(a=s+g);const h=a-n;o.trackList[e.lineIndex].list[e.itemIndex].offsetR=Math.max(f-h,0)}else o.trackList[e.lineIndex].list[e.itemIndex].frameCount=a-s;o.trackList[e.lineIndex].list[e.itemIndex].end=a}}function A(i,t){var c;i.preventDefault(),i.stopPropagation(),I=[];for(let d=0;d<o.trackList.length;d++)for(let m=0;m<o.trackList[d].list.length;m++)if(d!==e.lineIndex||m!==e.itemIndex){const l=o.trackList[d].list[m];I.push({start:l.start,end:l.end,left:b(o.trackScale,l.start),right:b(o.trackScale,l.end)})}S.isPause=!0;const{pageX:r}=i;E=r,M=!0,F(((c=o.trackList[e.lineIndex])==null?void 0:c.list)||[],y.value);const s=y.value.start,n=y.value.end,f=v.value.closest(".trackItem"),u=t==="left"?f.offsetLeft:f.offsetLeft+f.offsetWidth;document.onmousemove=d=>{if(!M)return;const{pageX:m}=d,l=E-m,p=C(u-l);o.dragData.fixLines=[p];const x=T(u-l,p),g=x!=null&&x.frame?t==="left"?x.frame-s:x.frame-n:-Math.round(l/D.value);N(g,t)},document.onmouseup=()=>{M=!1,document.onmouseup=null,document.onmousemove=null}}return(i,t)=>z((q(),G("div",{class:H(["absolute left-0 right-0 top-0 bottom-0 border z-20",{"dark:border-gray-100 border-gray-600":k.isActive}]),ref_key:"el",ref:v},[L("div",{class:"cursor-c-resize flex flex-col justify-center absolute -top-px -bottom-px -left-2 text-center rounded-tl rounded-bl w-2 dark:bg-gray-100 bg-gray-500 dark:text-gray-800 text-gray-100",ref:"handlerLeft",onMousedown:t[0]||(t[0]=r=>A(r,"left"))},t[2]||(t[2]=[L("span",null,"|",-1)]),544),L("div",{class:"cursor-c-resize flex flex-col justify-center absolute -top-px -bottom-px -right-2 text-center rounded-tr rounded-br w-2 dark:bg-gray-100 bg-gray-500 dark:text-gray-800 text-gray-100",ref:"handlerRight",onMousedown:t[1]||(t[1]=r=>A(r,"right"))},t[3]||(t[3]=[L("span",null,"|",-1)]),544)],2)),[[B,k.isActive]])}});export{K as _};
