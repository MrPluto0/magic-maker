import{d as N,C as X,O as j,D as C,r as z,n as B,Y as V,g as G,k as L,L as H,J as R,e as O}from"./index-DnwN-RZ1.js";import{g as b}from"./canvasUtil-Cql1jrBt.js";const q=N({__name:"TrackHandler",props:{isActive:{type:Boolean,default:!1},lineIndex:{type:Number,default:0},itemIndex:{type:Number,default:0}},setup(k){const e=k,o=X(),S=j(),y=C(()=>o.trackList[e.lineIndex].list[e.itemIndex]),v=z();let E=0,w={isVA:!1,start:0,end:0,offsetR:0,offsetL:0,minStart:0,maxStart:0,minEnd:0,maxEnd:0},M=!1,I=[];function W(i,t=10){const r=[];I.forEach(n=>{Math.abs(n.left-i)<=t&&r.push({position:n.left,frame:n.start}),Math.abs(n.right-i)<=t&&r.push({position:n.right,frame:n.end})});const a=b(o.trackScale,S.playStartFrame);return Math.abs(a-i)<=t&&r.push({position:a,frame:S.playStartFrame}),r}function T(i,t){return t.length===0?void 0:t.reduce((a,n)=>Math.abs(n.position-i)<Math.abs(a.position-i)?n:a,{position:Number.MAX_SAFE_INTEGER,frame:0})}const D=C(()=>b(o.trackScale,1));function F(i,t){const r=e.itemIndex>0?i[e.itemIndex-1]:null,a=e.itemIndex<i.length?i[e.itemIndex+1]:null,n=["video","audio"].includes(t.type),f={isVA:n,start:t.start,end:t.end,offsetR:t.offsetR,offsetL:t.offsetL,minStart:r?r.end:0,maxStart:t.end-1,minEnd:t.start+1,maxEnd:a?a.start:R*60*60};if(n){const u=t.frameCount-f.offsetL,c=t.frameCount-f.offsetR;f.maxEnd=a?Math.min(a.start,f.start+u):Math.min(u+f.start,R*60*60),f.minStart=r?Math.max(r.end,f.end-c):Math.max(f.end-c,0)}Object.assign(w,{...f})}function P(i,t){const{isVA:r,start:a,end:n,offsetR:f,offsetL:u,minStart:c,maxStart:d,minEnd:m,maxEnd:l}=w,p=n-a,x=u+p,g=f+p;if(t==="left"){let s=a+i;s>d&&(s=d),s<c&&(s=c);let h=s-a;r?(n-s>x&&(s=n-x,h=s-a),o.trackList[e.lineIndex].list[e.itemIndex].offsetL=Math.max(u+h,0)):o.trackList[e.lineIndex].list[e.itemIndex].frameCount=n-s,o.trackList[e.lineIndex].list[e.itemIndex].start=s}else{let s=n+i;if(s>l&&(s=l),s<m&&(s=m),r){s-a>g&&(s=a+g);const h=s-n;o.trackList[e.lineIndex].list[e.itemIndex].offsetR=Math.max(f-h,0)}else o.trackList[e.lineIndex].list[e.itemIndex].frameCount=s-a;o.trackList[e.lineIndex].list[e.itemIndex].end=s}}function A(i,t){var c;i.preventDefault(),i.stopPropagation(),I=[];for(let d=0;d<o.trackList.length;d++)for(let m=0;m<o.trackList[d].list.length;m++)if(d!==e.lineIndex||m!==e.itemIndex){const l=o.trackList[d].list[m];I.push({start:l.start,end:l.end,left:b(o.trackScale,l.start),right:b(o.trackScale,l.end)})}S.isPause=!0;const{pageX:r}=i;E=r,M=!0,F(((c=o.trackList[e.lineIndex])==null?void 0:c.list)||[],y.value);const a=y.value.start,n=y.value.end,f=v.value.closest(".trackItem"),u=t==="left"?f.offsetLeft:f.offsetLeft+f.offsetWidth;document.onmousemove=d=>{if(!M)return;const{pageX:m}=d,l=E-m,p=W(u-l);o.dragData.fixLines=[p];const x=T(u-l,p),g=x!=null&&x.frame?t==="left"?x.frame-a:x.frame-n:-Math.round(l/D.value);P(g,t)},document.onmouseup=()=>{M=!1,document.onmouseup=null,document.onmousemove=null}}return(i,t)=>B((O(),G("div",{class:H(["absolute left-0 right-0 top-0 bottom-0 border z-20",{"dark:border-gray-100 border-gray-600":k.isActive}]),ref_key:"el",ref:v},[L("div",{class:"cursor-c-resize flex flex-col justify-center absolute -top-px -bottom-px -left-2 text-center rounded-tl rounded-bl w-2 dark:bg-gray-100 bg-gray-500 dark:text-gray-800 text-gray-100",ref:"handlerLeft",onMousedown:t[0]||(t[0]=r=>A(r,"left"))},t[2]||(t[2]=[L("span",null,"|",-1)]),544),L("div",{class:"cursor-c-resize flex flex-col justify-center absolute -top-px -bottom-px -right-2 text-center rounded-tr rounded-br w-2 dark:bg-gray-100 bg-gray-500 dark:text-gray-800 text-gray-100",ref:"handlerRight",onMousedown:t[1]||(t[1]=r=>A(r,"right"))},t[3]||(t[3]=[L("span",null,"|",-1)]),544)],2)),[[V,k.isActive]])}});export{q as _};
