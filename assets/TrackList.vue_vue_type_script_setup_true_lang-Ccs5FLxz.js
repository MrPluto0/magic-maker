import{d as ct,D as ft,N as dt,r as d,G as T,X as ut,g as m,f as b,h as B,u as S,Y as gt,t as pt,s as M,F as z,l as H,q as mt,V as ht,i as V,H as kt,e as u,J as k,c as vt,n as xt}from"./index-C9HzHbyJ.js";import{_ as yt}from"./TimeLine.vue_vue_type_script_setup_true_lang-DS2rOdOD.js";import Lt from"./TrackLine-CjPZIphZ.js";import{_ as Dt}from"./TrackListIcon.vue_vue_type_script_setup_true_lang-DCHJlcJ6.js";import It from"./TrackPlayPoint-B2TfzNYF.js";import{g,a as y}from"./canvasUtil-Buwp7mdT.js";const wt={class:"trackList flex flex-1 flex-row w-full overflow-x-hidden overflow-y-auto relative"},Tt={key:0,class:"flex justify-center items-center h-24 m-auto w-2/3 dark:bg-gray-500 bg-gray-200 rounded-md text-sm border-dashed border-2 dark:border-gray-500 border-gray-200 hover:dark:border-blue-300 hover:border-blue-400"},Ct=ct({__name:"TrackList",setup(bt){const t=ft(),v=dt(),F=d(),C=d(),L={left:10,right:200},E=d(0-L.left),Y=d(0),D=T(()=>t.trackScale),G=T(()=>({width:g(D.value,t.frameCount)+L.right})),R=d(-1),x=d(0),W=d(!0),j=T(()=>t.dragData.dragPoint),q=d(0),h=T(()=>t.trackList.map((a,e)=>{a.main&&(q.value=e);const n=a.list.map(r=>({...r,showWidth:`${g(D.value,r.end-r.start)}px`,showLeft:`${g(D.value,r.start)}px`}));return{...a,list:n}}));function K(a,e,n){a.preventDefault(),a.stopPropagation(),t.selectTrackItem.line=e,t.selectTrackItem.index=n}function J(a){const e=a-1,n=e<0?0:e;v.isPause=!0,v.playStartFrame=n}let I=0;const O=ut(()=>{t.trackScale-=I>0?10:-10,I=0},100),U=a=>{(a.ctrlKey||a.metaKey)&&(a.preventDefault(),I||(I=a.deltaY),O())};function Q(){const{scrollLeft:a,scrollTop:e}=F.value;E.value=a-L.left,Y.value=e}let p={left:0,right:0,start:0,end:0},P=[],l;function Z(a){const e=window.getComputedStyle(a);return{left:parseInt(e.left),right:parseInt(e.left)+parseInt(e.width)}}function tt(a){if(l=a.target.closest(".trackItem"),!l)return;v.isPause=!0;const e=Number(l.dataset.line),n=Number(l.dataset.index);t.dragData.dragPoint.x=a.pageX,t.dragData.dragPoint.y=a.pageY,t.dragData.dataInfo=t.trackList[e].list[n],t.dragData.dragType=l.dataset.type,t.moveTrackData.lineIndex=e,t.moveTrackData.itemIndex=n,t.selectTrackItem.line=-1,t.selectTrackItem.index=0;const r=t.trackList[e].list[n];p={start:r.start,end:r.end,left:g(t.trackScale,r.start),right:g(t.trackScale,r.end)},P=[];for(let s=0;s<t.trackList.length;s++)for(let o=0;o<t.trackList[s].list.length;o++)if(s!==e||o!==n){const i=t.trackList[s].list[o];P.push({start:i.start,end:i.end,left:g(t.trackScale,i.start),right:g(t.trackScale,i.end)})}}function et(a,e,{start:n,end:r}){if(a.type!==e.type)return{overlap:!0,index:0};const s=e.list.filter(o=>o.id!==a.id);if(s.length===0)return{overlap:!1,index:0};if(s[0].start>=r)return{overlap:!1,index:0};if(s[s.length-1].end<=n)return{overlap:!1,index:s.length};for(let o=0;o<s.length-1;o++){const i=s[o],f=s[o+1];if(n>=i.end&&r<=f.start)return{overlap:!1,index:o+1}}return{overlap:!0,index:0}}function at(){const a=l.offsetTop+l.offsetHeight/2+l.offsetParent.offsetTop,e=Array.from(document.querySelectorAll(".trackLine"));if(e[0].offsetTop>a)return{isNewLine:!0,insertIndex:0};for(let n=0;n<e.length;n++){const r=e[n];if(r.offsetTop<=a&&r.offsetTop+r.offsetHeight>=a)return{isNewLine:!1,insertIndex:n,elem:r};if(n+1!==e.length){const s=e[n+1];if(r.offsetTop+r.offsetHeight<=a&&s.offsetTop>=a)return{isNewLine:!0,insertIndex:n+1}}}return{isNewLine:!0,insertIndex:e.length}}let c={left:0,right:0,start:0,end:0};function rt(){let{isNewLine:a,insertIndex:e,elem:n}=at();const r=Z(l),s=c.left||r.left,o=c.right||r.right,i=c.start||y(s,t.trackScale,k),f=c.end||y(o,t.trackScale,k);if(!n)return{insertIndex:e,itemIndex:0,left:s,right:o,isNewLine:a,start:i,end:f};const _=t.dragData.dataInfo,X=t.trackList[e],{overlap:N,index:lt}=et(_,X,{start:i,end:f});return N&&(a=!0,n.offsetLeft+n.offsetWidth/2<l.offsetTop+l.offsetParent.offsetTop+l.offsetHeight/2&&(e-=1)),{insertIndex:e,itemIndex:lt,left:s,right:o,isNewLine:a,start:i,end:f}}function w(a,e=10){const n=[];P.forEach(s=>{Math.abs(s.left-a)<=e&&n.push({position:s.left,frame:s.start}),Math.abs(s.right-a)<=e&&n.push({position:s.right,frame:s.end})});const r=g(t.trackScale,v.playStartFrame);return Math.abs(r-a)<=e&&n.push({position:r,frame:v.playStartFrame}),n}function A({left:a,right:e},n){if(c={left:0,right:0,start:0,end:0},n[0].length===0&&n[1].length===0)return;const r=n[0].reduce((o,i)=>Math.abs(i.position-a)<Math.abs(o.position-a)?i:o,{position:Number.MAX_SAFE_INTEGER,frame:0}),s=n[1].reduce((o,i)=>Math.abs(i.position-e)<Math.abs(o.position-e)?i:o,{position:Number.MAX_SAFE_INTEGER,frame:0});Math.abs(r.position-a)<Math.abs(s.position-e)?(c.left=r.position,c.start=r.frame,t.dragData.moveX=r.position-p.left):(c.right=s.position,c.end=s.frame,t.dragData.moveX=s.position-p.right)}function nt(a){if(l){t.dragData.moveX=a.pageX-t.dragData.dragPoint.x,t.dragData.moveY=a.pageY-t.dragData.dragPoint.y;const e=t.dragData.moveX+p.left,n=t.dragData.moveX+p.right;t.dragData.fixLines=[w(e),w(n)],A({left:e,right:n},t.dragData.fixLines)}}function st(a){const e=t.dragData.dataInfo,n=Math.max(c.right!==0?y(a.right,t.trackScale,k)-(e.end-e.start):y(a.left,t.trackScale,k),0);e.end=n+(e.end-e.start),e.start=n;const r=e;let s=0,o=0;t.trackList.forEach((f,_)=>{f.list.forEach((X,N)=>{X.id===e.id&&(s=_,o=N)})}),t.trackList[s].list.splice(o,1),a.isNewLine?t.trackList.splice(a.insertIndex,0,{type:r.type,list:[r]}):t.trackList[a.insertIndex].list.splice(a.itemIndex,0,r);const i=t.trackList.findIndex(f=>f.list.length===0);i!==-1&&t.trackList.splice(i,1)}function $(a){if(l){t.dragData.moveX=a.pageX-t.dragData.dragPoint.x,t.dragData.moveY=a.pageY-t.dragData.dragPoint.y;const e=t.dragData.moveX+p.left,n=t.dragData.moveX+p.right;t.dragData.fixLines=[w(e),w(n)],A({left:e,right:n},t.dragData.fixLines);const r=rt();st(r),l=null}t.dragData.fixLines=[],t.moveTrackData.lineIndex=-1,t.moveTrackData.itemIndex=-1,t.dragData.moveX=0,t.dragData.moveY=0}function ot(a){const e=C.value,{left:n}=e.getBoundingClientRect(),{clientX:r}=a,{x:s}=j.value,o=r-n-s;x.value=o<0?0:o}async function it(){const a=y(x.value,t.trackScale,k),e=await t.createTrack(t.dragData.dataInfo,a);t.addTrack(e),x.value=0,t.dragData.dataInfo={},t.moveTrackData.lineIndex=-1,t.moveTrackData.itemIndex=-1,t.dragData.moveX=0,t.dragData.moveY=0}return(a,e)=>{const n=kt("Icon");return u(),m("div",wt,[b(Dt,{listData:h.value,offsetTop:Y.value},null,8,["listData","offsetTop"]),B("div",{class:"flex-1 overflow-x-scroll overflow-y-auto flex-col shrink-0 grow relative",ref_key:"trackList",ref:F,onScroll:Q,onWheel:U,onClick:e[0]||(e[0]=r=>K(r,-1,-1))},[b(yt,{start:E.value,scale:D.value,step:S(k),focusPosition:S(t).selectTrack,onSelectFrame:J},null,8,["start","scale","step","focusPosition"]),B("div",{class:"absolute top-5 flex shrink-0 grow min-w-full",style:{"min-height":"calc(100% - 20px)"},ref_key:"trackListContainer",ref:C,onMousedown:tt,onMousemove:nt,onMouseup:$,onMouseleave:$,onDragover:gt(ot,["stop","prevent"]),onDrop:it},[h.value.length===0?(u(),m("div",Tt,[b(n,{icon:"i-mdi-video",class:"text-xl mr-4"}),e[1]||(e[1]=pt(" 将素材拖拽到这里，开始编辑你的大作吧~ "))])):(u(),m("div",{key:1,class:"z-10 pt-5 pb-5 min-w-full flex shrink-0 grow flex-col justify-center min-h-full",style:M({width:`${G.value.width}px`}),id:"track-container"},[(u(!0),m(z,null,H(h.value,(r,s)=>(u(),vt(Lt,{key:r.list.reduce((o,i)=>o+i.id,"line"),style:M({"margin-left":`${L.left}px`}),class:xt([R.value===s?W.value?"showLine-t":"showLine-b":""]),lineType:r.type,isActive:S(t).selectTrackItem.line===s,lineIndex:s,isMain:r.main,lineData:r.list},null,8,["style","class","lineType","isActive","lineIndex","isMain","lineData"]))),128))],4)),mt(b(It,null,null,512),[[ht,h.value.length!==0]]),h.value.length!==0?(u(!0),m(z,{key:2},H(S(t).dragData.fixLines.reduce((r,s)=>r.concat(s),[]),(r,s)=>(u(),m("div",{key:s,class:"z-30 w-px absolute -top-5 bottom-0 bg-yellow-300 dark:bg-yellow-300 pointer-events-none",style:M({left:`${r.position+10}px`})},null,4))),128)):V("",!0),h.value.length!==0&&x.value!==0?(u(),m("div",{key:3,class:"z-30 w-px absolute -top-5 bottom-0 bg-yellow-300 dark:bg-yellow-300",style:M({left:`${x.value}px`})},null,4)):V("",!0)],544)],544)])}}});export{Ct as _};
