import{d as ct,C as ft,O as dt,r as d,D as T,a5 as ut,g as m,f as b,k as B,u as S,a6 as gt,q as pt,p as M,Q as z,R,n as mt,Y as ht,h as V,e as u,J as k,a7 as kt,c as xt,L as vt}from"./index-DnwN-RZ1.js";import{_ as yt}from"./TimeLine.vue_vue_type_script_setup_true_lang-BzExzWQM.js";import Lt from"./TrackLine-Bloh6xLC.js";import{_ as Dt}from"./TrackListIcon.vue_vue_type_script_setup_true_lang-4Bd_sYzJ.js";import wt from"./TrackPlayPoint-DMLb0pkJ.js";import{g,a as y}from"./canvasUtil-Cql1jrBt.js";const It={class:"trackList flex flex-1 flex-row w-full overflow-x-hidden overflow-y-auto relative"},Tt={key:0,class:"flex justify-center items-center h-24 m-auto w-2/3 dark:bg-gray-500 bg-gray-200 rounded-md text-sm border-dashed border-2 dark:border-gray-500 border-gray-200 hover:dark:border-blue-300 hover:border-blue-400"},Ct=ct({__name:"TrackList",setup(bt){const t=ft(),x=dt(),F=d(),C=d(),L={left:10,right:200},E=d(0-L.left),Y=d(0),D=T(()=>t.trackScale),H=T(()=>({width:g(D.value,t.frameCount)+L.right})),W=d(-1),v=d(0),j=d(!0),G=T(()=>t.dragData.dragPoint);let q=d(0);const h=T(()=>t.trackList.map((a,e)=>{a.main&&(q.value=e);const r=a.list.map(n=>({...n,showWidth:`${g(D.value,n.end-n.start)}px`,showLeft:`${g(D.value,n.start)}px`}));return{...a,list:r}}));function K(a,e,r){a.preventDefault(),a.stopPropagation(),t.selectTrackItem.line=e,t.selectTrackItem.index=r}function O(a){const e=a-1,r=e<0?0:e;x.isPause=!0,x.playStartFrame=r}let w=0;const J=ut(()=>{t.trackScale-=w>0?10:-10,w=0},100),Q=a=>{(a.ctrlKey||a.metaKey)&&(a.preventDefault(),w||(w=a.deltaY),J())};function U(){const{scrollLeft:a,scrollTop:e}=F.value;E.value=a-L.left,Y.value=e}let p={left:0,right:0,start:0,end:0},P=[],l;function Z(a){const e=window.getComputedStyle(a);return{left:parseInt(e.left),right:parseInt(e.left)+parseInt(e.width)}}function tt(a){if(l=a.target.closest(".trackItem"),!l)return;x.isPause=!0;const e=Number(l.dataset.line),r=Number(l.dataset.index);t.dragData.dragPoint.x=a.pageX,t.dragData.dragPoint.y=a.pageY,t.dragData.dataInfo=t.trackList[e].list[r],t.dragData.dragType=l.dataset.type,t.moveTrackData.lineIndex=e,t.moveTrackData.itemIndex=r,t.selectTrackItem.line=-1,t.selectTrackItem.index=0;const n=t.trackList[e].list[r];p={start:n.start,end:n.end,left:g(t.trackScale,n.start),right:g(t.trackScale,n.end)},P=[];for(let s=0;s<t.trackList.length;s++)for(let o=0;o<t.trackList[s].list.length;o++)if(s!==e||o!==r){const i=t.trackList[s].list[o];P.push({start:i.start,end:i.end,left:g(t.trackScale,i.start),right:g(t.trackScale,i.end)})}}function et(a,e,{start:r,end:n}){if(a.type!==e.type)return{overlap:!0,index:0};const s=e.list.filter(o=>o.id!==a.id);if(s.length===0)return{overlap:!1,index:0};if(s[0].start>=n)return{overlap:!1,index:0};if(s[s.length-1].end<=r)return{overlap:!1,index:s.length};for(let o=0;o<s.length-1;o++){const i=s[o],f=s[o+1];if(r>=i.end&&n<=f.start)return{overlap:!1,index:o+1}}return{overlap:!0,index:0}}function at(){const a=l.offsetTop+l.offsetHeight/2+l.offsetParent.offsetTop,e=Array.from(document.querySelectorAll(".trackLine"));if(e[0].offsetTop>a)return{isNewLine:!0,insertIndex:0};for(let r=0;r<e.length;r++){const n=e[r];if(n.offsetTop<=a&&n.offsetTop+n.offsetHeight>=a)return{isNewLine:!1,insertIndex:r,elem:n};if(r+1!==e.length){const s=e[r+1];if(n.offsetTop+n.offsetHeight<=a&&s.offsetTop>=a)return{isNewLine:!0,insertIndex:r+1}}}return{isNewLine:!0,insertIndex:e.length}}let c={left:0,right:0,start:0,end:0};function rt(){let{isNewLine:a,insertIndex:e,elem:r}=at();const n=Z(l),s=c.left||n.left,o=c.right||n.right,i=c.start||y(s,t.trackScale,k),f=c.end||y(o,t.trackScale,k);if(!r)return{insertIndex:e,itemIndex:0,left:s,right:o,isNewLine:a,start:i,end:f};const _=t.dragData.dataInfo,X=t.trackList[e],{overlap:N,index:lt}=et(_,X,{start:i,end:f});return N&&(a=!0,r.offsetLeft+r.offsetWidth/2<l.offsetTop+l.offsetParent.offsetTop+l.offsetHeight/2&&(e-=1)),{insertIndex:e,itemIndex:lt,left:s,right:o,isNewLine:a,start:i,end:f}}function I(a,e=10){const r=[];P.forEach(s=>{Math.abs(s.left-a)<=e&&r.push({position:s.left,frame:s.start}),Math.abs(s.right-a)<=e&&r.push({position:s.right,frame:s.end})});const n=g(t.trackScale,x.playStartFrame);return Math.abs(n-a)<=e&&r.push({position:n,frame:x.playStartFrame}),r}function A({left:a,right:e},r){if(c={left:0,right:0,start:0,end:0},r[0].length===0&&r[1].length===0)return;const n=r[0].reduce((o,i)=>Math.abs(i.position-a)<Math.abs(o.position-a)?i:o,{position:Number.MAX_SAFE_INTEGER,frame:0}),s=r[1].reduce((o,i)=>Math.abs(i.position-e)<Math.abs(o.position-e)?i:o,{position:Number.MAX_SAFE_INTEGER,frame:0});Math.abs(n.position-a)<Math.abs(s.position-e)?(c.left=n.position,c.start=n.frame,t.dragData.moveX=n.position-p.left):(c.right=s.position,c.end=s.frame,t.dragData.moveX=s.position-p.right)}function nt(a){if(l){t.dragData.moveX=a.pageX-t.dragData.dragPoint.x,t.dragData.moveY=a.pageY-t.dragData.dragPoint.y;const e=t.dragData.moveX+p.left,r=t.dragData.moveX+p.right;t.dragData.fixLines=[I(e),I(r)],A({left:e,right:r},t.dragData.fixLines)}}function st(a){let e=t.dragData.dataInfo;const r=Math.max(c.right!==0?y(a.right,t.trackScale,k)-(e.end-e.start):y(a.left,t.trackScale,k),0);e.end=r+(e.end-e.start),e.start=r;const n=e;let s=0,o=0;t.trackList.forEach((f,_)=>{f.list.forEach((X,N)=>{X.id===e.id&&(s=_,o=N)})}),t.trackList[s].list.splice(o,1),a.isNewLine?t.trackList.splice(a.insertIndex,0,{type:n.type,list:[n]}):t.trackList[a.insertIndex].list.splice(a.itemIndex,0,n);const i=t.trackList.findIndex(f=>f.list.length===0);i!==-1&&t.trackList.splice(i,1)}function $(a){if(l){t.dragData.moveX=a.pageX-t.dragData.dragPoint.x,t.dragData.moveY=a.pageY-t.dragData.dragPoint.y;const e=t.dragData.moveX+p.left,r=t.dragData.moveX+p.right;t.dragData.fixLines=[I(e),I(r)],A({left:e,right:r},t.dragData.fixLines);const n=rt();st(n),l=null}t.dragData.fixLines=[],t.moveTrackData.lineIndex=-1,t.moveTrackData.itemIndex=-1,t.dragData.moveX=0,t.dragData.moveY=0}function ot(a){const e=C.value,{left:r}=e.getBoundingClientRect(),{clientX:n}=a,{x:s}=G.value,o=n-r-s;v.value=o<0?0:o}async function it(){const a=y(v.value,t.trackScale,k),e=await t.createTrack(t.dragData.dataInfo,a);t.addTrack(e),v.value=0,t.dragData.dataInfo={},t.moveTrackData.lineIndex=-1,t.moveTrackData.itemIndex=-1,t.dragData.moveX=0,t.dragData.moveY=0}return(a,e)=>(u(),m("div",It,[b(Dt,{listData:h.value,offsetTop:Y.value},null,8,["listData","offsetTop"]),B("div",{class:"flex-1 overflow-x-scroll overflow-y-auto flex-col shrink-0 grow relative",ref_key:"trackList",ref:F,onScroll:U,onWheel:Q,onClick:e[0]||(e[0]=r=>K(r,-1,-1))},[b(yt,{start:E.value,scale:D.value,step:S(k),focusPosition:S(t).selectTrack,onSelectFrame:O},null,8,["start","scale","step","focusPosition"]),B("div",{class:"absolute top-5 flex shrink-0 grow min-w-full",style:{"min-height":"calc(100% - 20px)"},ref_key:"trackListContainer",ref:C,onMousedown:tt,onMousemove:nt,onMouseup:$,onMouseleave:$,onDragover:gt(ot,["stop","prevent"]),onDrop:it},[h.value.length===0?(u(),m("div",Tt,[b(kt,{class:"text-xl mr-4"}),e[1]||(e[1]=pt(" 将素材拖拽到这里，开始编辑你的大作吧~ "))])):(u(),m("div",{key:1,class:"z-10 pt-5 pb-5 min-w-full flex shrink-0 grow flex-col justify-center min-h-full",style:M({width:`${H.value.width}px`}),id:"track-container"},[(u(!0),m(z,null,R(h.value,(r,n)=>(u(),xt(Lt,{key:r.list.reduce((s,o)=>s+o.id,"line"),style:M({"margin-left":`${L.left}px`}),class:vt([W.value===n?j.value?"showLine-t":"showLine-b":""]),lineType:r.type,isActive:S(t).selectTrackItem.line===n,lineIndex:n,isMain:r.main,lineData:r.list},null,8,["style","class","lineType","isActive","lineIndex","isMain","lineData"]))),128))],4)),mt(b(wt,null,null,512),[[ht,h.value.length!==0]]),h.value.length!==0?(u(!0),m(z,{key:2},R(S(t).dragData.fixLines.reduce((r,n)=>r.concat(n),[]),(r,n)=>(u(),m("div",{key:n,class:"z-30 w-px absolute -top-5 bottom-0 bg-yellow-300 dark:bg-yellow-300 pointer-events-none",style:M({left:`${r.position+10}px`})},null,4))),128)):V("",!0),h.value.length!==0&&v.value!==0?(u(),m("div",{key:3,class:"z-30 w-px absolute -top-5 bottom-0 bg-yellow-300 dark:bg-yellow-300",style:M({left:`${v.value}px`})},null,4)):V("",!0)],544)],544)]))}});export{Ct as _};
